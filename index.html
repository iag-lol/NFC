<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b1220" />
<title>Editor NFC — Móvil, claro y responsivo</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#22d3ee; --muted:#9fb1c8; --danger:#ef4444; --ok:#22c55e;
    --glass: rgba(255,255,255,0.05);
    font-synthesis-weight: none;
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#081226 0%, #091329 70%);color:#e6eef8;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
  .container{max-width:1024px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, rgba(8,18,38,.95), rgba(8,18,38,.7));backdrop-filter: blur(6px);border-bottom:1px solid rgba(255,255,255,.04)}
  header .bar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px}
  h1{font-size:18px;margin:0}
  .pill{padding:8px 10px;border-radius:999px;background:var(--glass);color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns: 380px 1fr;gap:14px;margin-top:14px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
  .row{display:flex;gap:8px;align-items:center}
  .col{display:flex;flex-direction:column;gap:10px}
  label{font-size:13px;color:var(--muted)}
  button, select, input[type="text"], textarea{appearance:none;-webkit-appearance:none;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.12);padding:12px;border-radius:12px;color:#eef4ff;font-size:15px;line-height:1.2}
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg, rgba(34,211,238,.25), rgba(34,211,238,.1));border-color:rgba(34,211,238,.5)}
  button.ghost{background:transparent}
  button.danger{border-color: rgba(239,68,68,.5);}
  .muted{color:var(--muted);font-size:13px}
  .state{display:flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:50%;background:#555}
  .dot.on{background:var(--ok)}
  .dot.err{background:var(--danger)}
  .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .rec{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
  .rec h3{margin:0 0 6px 0;font-size:14px}
  textarea{min-height:86px;resize:vertical}
  .actions{display:flex;flex-wrap:wrap;gap:8px}
  .help{font-size:12.5px;color:var(--muted)}
  .sticky-actions{position:sticky;bottom:0;z-index:15;background:linear-gradient(180deg, rgba(8,18,38,0), rgba(8,18,38,.7) 25%, rgba(8,18,38,.95));padding:10px 8px;border-top:1px solid rgba(255,255,255,.06);margin-top:8px}
  .btn-wide{flex:1;min-width:140px}

  /* Responsive */
  @media (max-width: 900px){
    .grid{grid-template-columns: 1fr}
    h1{font-size:17px}
    button, input, textarea, select{font-size:16px} /* evita zoom en mobile */
  }
  @media (max-width: 420px){
    .btn-wide{min-width: unset}
  }
</style>
</head>
<body>
  <header>
    <div class="container bar">
      <div class="row">
        <h1>Editor NFC — móvil</h1>
        <span class="pill">Web NFC (Android + HTTPS)</span>
      </div>
      <div class="row">
        <span class="state"><span id="dot" class="dot"></span><span id="stateTxt" class="muted">Inactivo</span></span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <!-- Panel izquierdo: control -->
      <section class="card col" aria-labelledby="panel-control">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted">Compatibilidad</div>
            <div id="compat" class="help">Comprobando...</div>
          </div>
          <div class="row">
            <button id="btnScan" class="primary" type="button">Iniciar escaneo</button>
          </div>
        </div>

        <div>
          <div class="muted">Último tag</div>
          <div id="last" class="help">—</div>
        </div>

        <div class="row" style="flex-wrap:wrap">
          <button id="btnBackup" class="ghost" type="button">Backup (JSON)</button>
          <button id="btnLoadBackup" class="ghost" type="button">Restaurar backup</button>
          <input id="fileBackup" type="file" accept="application/json" hidden>
        </div>

        <div>
          <div class="muted">Plantillas</div>
          <div id="tmplChips" class="row" style="flex-wrap:wrap"></div>
          <div class="row">
            <input id="tmplName" type="text" placeholder="Nombre de plantilla" autocomplete="off" />
            <button id="btnSaveTmpl" type="button">Guardar</button>
          </div>
        </div>

        <div>
          <div class="muted">Reemplazo rápido</div>
          <div class="row"><input id="qFind" type="text" placeholder="Buscar..."><input id="qRepl" type="text" placeholder="Reemplazar por..."></div>
          <div class="row"><button id="btnReplaceOne" type="button">Aplicar</button><button id="btnReplaceAll" type="button">Aplicar a todos</button></div>
        </div>

        <div class="help">Consejo: usa <b>Backup</b> antes de escribir. No todos los tags son regrabables.</div>
      </section>

      <!-- Panel derecho: editor y escritura -->
      <section class="card col" aria-labelledby="panel-editor">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <div class="muted">Registros NDEF en el editor</div>
            <div id="count">0</div>
          </div>
          <div class="actions">
            <button id="btnClear" class="ghost" type="button">Limpiar</button>
          </div>
        </div>

        <div id="list" class="list"></div>

        <div class="row" style="margin-top:6px">
          <button id="btnAdd" type="button">Agregar registro</button>
          <button id="btnExportTmpl" type="button">Exportar plantilla</button>
          <button id="btnImportTmpl" type="button">Importar plantilla</button>
          <input id="fileTemplate" type="file" accept="application/json" hidden>
        </div>

        <div class="sticky-actions">
          <div class="actions">
            <button id="btnWrite" class="primary btn-wide" type="button">Escribir en tag</button>
            <button id="btnStop" class="btn-wide" type="button">Detener escaneo</button>
          </div>
          <div class="help" id="hint">Para escribir, pulsa el botón y acerca la tarjeta cuando el navegador lo pida.</div>
        </div>
      </section>
    </div>
  </main>

<script>
// ===== Utilidades =====
const $ = s => document.querySelector(s);
const el = (t, a={}, kids=[])=>{const n=document.createElement(t);for(const[k,v]of Object.entries(a)){if(k.startsWith('on')&&typeof v==='function')n.addEventListener(k.slice(2),v);else if(k==='html')n.innerHTML=v;else n.setAttribute(k,v);} (Array.isArray(kids)?kids:[kids]).forEach(c=>n.appendChild(typeof c==='string'?document.createTextNode(c):c));return n}
const safeJSON = s=>{try{return JSON.parse(s)}catch{ return null }}
const vibrate = ms=>('vibrate' in navigator)&&navigator.vibrate(ms)
const isSecure = () => window.isSecureContext

// ===== Estado =====
let ndef = null;
let scanAbort = null; // AbortController para parar correctamente
let scanning = false;
let lastSerial = null;
let records = []; // {recordType, mediaType?, id?, value}
const STORE = 'nfc_editor_templates_v2';

// ===== UI refs =====
const dot=$('#dot'), stateTxt=$('#stateTxt'), compat=$('#compat'), last=$('#last'), list=$('#list'), count=$('#count');

// ===== Compatibilidad rápida =====
function checkCompat(){
  const hasNFC = 'NDEFReader' in window;
  const msg = !isSecure() ? 'Se requiere HTTPS o localhost.' : hasNFC ? 'OK: Web NFC disponible.' : 'No disponible: usa Chrome en Android.';
  compat.textContent = msg;
  compat.style.color = (!isSecure()||!hasNFC)? '#fca5a5' : '';
}
checkCompat();

// ===== Render de registros =====
function render(){
  list.innerHTML='';
  count.textContent = records.length;
  if(records.length===0){
    list.appendChild(el('div',{class:'help'},'Sin registros. Escanea un tag o agrega uno nuevo.'));
    return;
  }
  records.forEach((r,i)=>{
    const card = el('div',{class:'rec'});
    card.appendChild(el('h3',{},`#${i} — ${r.recordType.toUpperCase()}`));
    const meta = el('div',{class:'row',style:'justify-content:space-between'},[
      el('span',{class:'help'}, r.mediaType||r.id||'')
    ]);
    card.appendChild(meta);

    const ta = el('textarea',{rows:4,placeholder:'Contenido…'});
    ta.value = r.value||'';
    ta.addEventListener('input',e=>{records[i].value=e.target.value});

    const typeSel = el('select',{},[
      el('option',{value:'text'},'text'),
      el('option',{value:'url'},'url'),
      el('option',{value:'mime'},'mime'),
      el('option',{value:'unknown'},'unknown')
    ]);
    typeSel.value=r.recordType; typeSel.addEventListener('change',e=>{records[i].recordType=e.target.value; render()});

    const row = el('div',{class:'actions',style:'margin-top:8px'},[
      typeSel,
      el('button',{class:'ghost',onclick:()=>{const c=JSON.parse(JSON.stringify(records[i]));records.splice(i+1,0,c);render()}},'Duplicar'),
      el('button',{class:'danger',onclick:()=>{records.splice(i,1);render()}},'Eliminar')
    ]);

    card.appendChild(ta); card.appendChild(row); list.appendChild(card);
  })
}

// ===== Lectura =====
function setScanUI(on){
  scanning = !!on;
  dot.classList.toggle('on', on);
  stateTxt.textContent = on? 'Escaneando — acerca un tag' : 'Inactivo';
}

async function startScan(){
  if(!('NDEFReader' in window)) return err('Web NFC no disponible en este navegador.');
  if(!isSecure()) return err('Se requiere HTTPS o localhost para usar Web NFC.');
  try{
    // Abort si ya hay una previa
    if(scanAbort){ scanAbort.abort(); scanAbort=null }
    scanAbort = new AbortController();
    ndef = new NDEFReader();

    // Algunas implementaciones requieren un gesto de usuario (este handler nace de un click)
    await ndef.scan({ signal: scanAbort.signal, keepReading: true });

    ndef.onreadingerror = () => warn('Error leyendo el tag. Intenta de nuevo.');
    ndef.onreading = ev => {
      const {serialNumber, message} = ev;
      lastSerial = serialNumber || 'desconocido';
      last.textContent = `Serial: ${lastSerial}`;
      // Parsear registros
      records = [];
      for(const rec of message.records){
        records.push(parseRecord(rec));
      }
      vibrate(15);
      render();
    };
    setScanUI(true);
    info('Escaneo activo. Acerca una tarjeta al móvil.');
  }catch(e){
    handleNFCError(e, 'No se pudo iniciar el escaneo');
    setScanUI(false);
  }
}

function stopScan(){
  try{ scanAbort?.abort(); } catch{}
  scanAbort = null; setScanUI(false); info('Escaneo detenido.');
}

function parseRecord(rec){
  let value='';
  try{
    const dv = rec.data; // DataView
    if(dv){
      const u8 = new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
      value = new TextDecoder().decode(u8);
    }
  }catch{ value='' }
  return { recordType: rec.recordType || 'unknown', mediaType: rec.mediaType || '', id: rec.id || '', value };
}

// ===== Escritura =====
async function writeToTag(){
  if(!('NDEFReader' in window)) return err('Web NFC no disponible.');
  if(!isSecure()) return err('HTTPS/localhost requerido para escribir.');
  const payload = records.map(r=>({
    recordType: r.recordType || 'text',
    ...(r.mediaType?{mediaType:r.mediaType}:{}) ,
    ...(r.id?{id:r.id}:{}) ,
    data: r.value ?? ''
  }));
  if(!confirm('Se escribirá el contenido actual en una tarjeta. ¿Continuar?')) return;
  try{
    // Escribir debe ejecutarse por gesto del usuario; este método lo llamamos desde click.
    const wr = new NDEFReader();
    await wr.write({ records: payload }); // el navegador te pedirá acercar el tag
    vibrate([30,40,30]);
    info('Escritura completada.');
  }catch(e){
    handleNFCError(e, 'No se pudo escribir en el tag');
  }
}

// ===== Backup / Plantillas =====
function downloadJSON(name, obj){
  const blob = new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function saveTemplates(obj){ localStorage.setItem(STORE, JSON.stringify(obj)); renderTmpls() }
function loadTemplates(){ const raw = localStorage.getItem(STORE); return raw? (safeJSON(raw)||{}):{} }
function renderTmpls(){
  const wrap = $('#tmplChips'); wrap.innerHTML='';
  const tmpls = loadTemplates();
  for(const [name, data] of Object.entries(tmpls)){
    const chip = el('button',{class:'ghost',onclick:()=>{records = data.records||[]; render(); info(`Plantilla "${name}" cargada`) }},name);
    chip.addEventListener('contextmenu',ev=>{ev.preventDefault(); if(confirm(`Eliminar plantilla "${name}"?`)){ delete tmpls[name]; saveTemplates(tmpls) }});
    wrap.appendChild(chip);
  }
}
renderTmpls();

// ===== Reemplazo rápido =====
function applyReplace(all=false){
  const f = $('#qFind').value; const r = $('#qRepl').value;
  if(!f){ return warn('Escribe texto a buscar'); }
  let n=0; records = records.map(rec=>{ if(typeof rec.value==='string' && rec.value.includes(f)){ rec.value = rec.value.split(f).join(r); n++; } return rec });
  render(); info(`Reemplazado en ${n} registro(s).`);
}

// ===== Mensajes =====
function info(t){ $('#hint').textContent = t }
function warn(t){ $('#hint').textContent = t }
function err(t){ $('#hint').textContent = t }

function handleNFCError(e, prefix){
  const m = e?.message || String(e);
  // Mapeo directo para mensajes claros en móvil
  if(m.includes('NotAllowedError')) return err(prefix+': permiso denegado. Toca el botón y concede permiso.');
  if(m.includes('NotSupportedError')) return err(prefix+': el dispositivo o navegador no soporta Web NFC.');
  if(m.includes('SecurityError')) return err(prefix+': requiere HTTPS/localhost.');
  if(m.includes('InvalidStateError')) return err(prefix+': ya hay un escaneo activo. Detén y vuelve a iniciar.');
  err(prefix+`. ${m}`);
  console.error(e);
}

// ===== Eventos =====
$('#btnScan').addEventListener('click', startScan, {passive:true});
$('#btnStop').addEventListener('click', stopScan, {passive:true});
$('#btnWrite').addEventListener('click', writeToTag, {passive:true});

$('#btnBackup').addEventListener('click', ()=>{
  if(records.length===0) return warn('No hay datos para backup');
  downloadJSON('nfc-backup-'+(lastSerial||'sin-serial')+'.json',{exportedAt:new Date().toISOString(), serial:lastSerial, records});
});
$('#btnLoadBackup').addEventListener('click', ()=> $('#fileBackup').click());
$('#fileBackup').addEventListener('change', ev=>{
  const f = ev.target.files[0]; if(!f) return; const fr = new FileReader(); fr.onload = e=>{ const parsed = safeJSON(e.target.result); if(!parsed||!parsed.records) return err('Backup inválido'); records = parsed.records; render(); info('Backup cargado (aún no escrito)') }; fr.readAsText(f);
});

$('#btnSaveTmpl').addEventListener('click', ()=>{
  const name = ($('#tmplName').value||'').trim(); if(!name) return warn('Ponle un nombre a la plantilla');
  const tmpls = loadTemplates(); tmpls[name] = {createdAt:new Date().toISOString(), records: JSON.parse(JSON.stringify(records))}; saveTemplates(tmpls); $('#tmplName').value=''; info('Plantilla guardada');
});

$('#btnExportTmpl').addEventListener('click', ()=> downloadJSON('nfc-template.json',{exportedAt:new Date().toISOString(), records}));
$('#btnImportTmpl').addEventListener('click', ()=> $('#fileTemplate').click());
$('#fileTemplate').addEventListener('change', ev=>{ const f = ev.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=e=>{ const p=safeJSON(e.target.result); if(!p||!p.records) return err('Plantilla inválida'); records=p.records; render(); info('Plantilla importada') }; fr.readAsText(f)});

$('#btnAdd').addEventListener('click', ()=>{ records.push({recordType:'text',value:''}); render(); });
$('#btnClear').addEventListener('click', ()=>{ if(confirm('¿Limpiar editor?')){ records=[]; render(); }});
$('#btnReplaceOne').addEventListener('click', ()=>applyReplace(false));
$('#btnReplaceAll').addEventListener('click', ()=>applyReplace(true));

// Pausar escaneo al cambiar de pestaña (mejor batería)
window.addEventListener('visibilitychange', ()=>{ if(document.hidden && scanning){ stopScan() } });

// Render inicial
render();
</script>
</body>
</html>
