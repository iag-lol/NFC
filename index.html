<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b1220" />
<title>Editor NFC — Móvil, claro y responsivo</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#22d3ee; --muted:#9fb1c8; --danger:#ef4444; --ok:#22c55e;
    --glass: rgba(255,255,255,0.05);
    font-synthesis-weight: none;
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#081226 0%, #091329 70%);color:#e6eef8;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
  .container{max-width:1024px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, rgba(8,18,38,.95), rgba(8,18,38,.7));backdrop-filter: blur(6px);border-bottom:1px solid rgba(255,255,255,.04)}
  header .bar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px}
  h1{font-size:18px;margin:0}
  .pill{padding:8px 10px;border-radius:999px;background:var(--glass);color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns: 380px 1fr;gap:14px;margin-top:14px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
  .row{display:flex;gap:8px;align-items:center}
  .col{display:flex;flex-direction:column;gap:10px}
  label{font-size:13px;color:var(--muted)}
  button, select, input[type="text"], textarea{appearance:none;-webkit-appearance:none;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.12);padding:12px;border-radius:12px;color:#eef4ff;font-size:15px;line-height:1.2}
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg, rgba(34,211,238,.25), rgba(34,211,238,.1));border-color:rgba(34,211,238,.5)}
  button.ghost{background:transparent}
  button.danger{border-color: rgba(239,68,68,.5);}
  .muted{color:var(--muted);font-size:13px}
  .state{display:flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:50%;background:#555}
  .dot.on{background:var(--ok)}
  .dot.err{background:var(--danger)}
  .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .rec{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
  .rec h3{margin:0 0 6px 0;font-size:14px}
  textarea{min-height:86px;resize:vertical}
  .actions{display:flex;flex-wrap:wrap;gap:8px}
  .help{font-size:12.5px;color:var(--muted)}
  .sticky-actions{position:sticky;bottom:0;z-index:15;background:linear-gradient(180deg, rgba(8,18,38,0), rgba(8,18,38,.7) 25%, rgba(8,18,38,.95));padding:10px 8px;border-top:1px solid rgba(255,255,255,.06);margin-top:8px}
  .btn-wide{flex:1;min-width:140px}

  /* Responsive */
  @media (max-width: 900px){
    .grid{grid-template-columns: 1fr}
    h1{font-size:17px}
    button, input, textarea, select{font-size:16px}
  }
  @media (max-width: 420px){
    .btn-wide{min-width: unset}
  }
</style>
</head>
<body>
  <header>
    <div class="container bar">
      <div class="row">
        <h1>Editor NFC — móvil</h1>
        <span class="pill">Web NFC (Android + HTTPS)</span>
      </div>
      <div class="row">
        <span class="state"><span id="dot" class="dot"></span><span id="stateTxt" class="muted">Inactivo</span></span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <!-- Panel izquierdo: control -->
      <section class="card col">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted">Compatibilidad</div>
            <div id="compat" class="help">Comprobando...</div>
          </div>
          <div class="row">
            <button id="btnScan" class="primary" type="button">Iniciar escaneo</button>
          </div>
        </div>

        <div>
          <div class="muted">Último tag</div>
          <div id="last" class="help">—</div>
        </div>

        <div class="row" style="flex-wrap:wrap">
          <button id="btnBackup" class="ghost" type="button">Backup (JSON)</button>
          <button id="btnLoadBackup" class="ghost" type="button">Restaurar backup</button>
          <input id="fileBackup" type="file" accept="application/json" hidden>
        </div>

        <div>
          <div class="muted">Plantillas</div>
          <div id="tmplChips" class="row" style="flex-wrap:wrap"></div>
          <div class="row">
            <input id="tmplName" type="text" placeholder="Nombre de plantilla" autocomplete="off" />
            <button id="btnSaveTmpl" type="button">Guardar</button>
          </div>
        </div>

        <div>
          <div class="muted">Reemplazo rápido</div>
          <div class="row"><input id="qFind" type="text" placeholder="Buscar..."><input id="qRepl" type="text" placeholder="Reemplazar por..."></div>
          <div class="row"><button id="btnReplaceOne" type="button">Aplicar</button><button id="btnReplaceAll" type="button">Aplicar a todos</button></div>
        </div>

        <div class="help">Consejo: usa <b>Backup</b> antes de escribir. No todos los tags son regrabables.</div>
      </section>

      <!-- Panel derecho: editor -->
      <section class="card col">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <div class="muted">Registros NDEF en el editor</div>
            <div id="count">0</div>
          </div>
          <div class="actions">
            <button id="btnClear" class="ghost" type="button">Limpiar</button>
          </div>
        </div>

        <div id="list" class="list"></div>

        <div class="row" style="margin-top:6px">
          <button id="btnAdd" type="button">Agregar registro</button>
          <button id="btnExportTmpl" type="button">Exportar plantilla</button>
          <button id="btnImportTmpl" type="button">Importar plantilla</button>
          <input id="fileTemplate" type="file" accept="application/json" hidden>
        </div>

        <div class="sticky-actions">
          <div class="actions">
            <button id="btnWrite" class="primary btn-wide" type="button">Escribir en tag</button>
            <button id="btnStop" class="btn-wide" type="button">Detener escaneo</button>
          </div>
          <div class="help" id="hint">Para escribir, pulsa el botón y acerca la tarjeta cuando el navegador lo pida.</div>
        </div>
      </section>
    </div>
  </main>

<script>
// === Helpers ===
const $ = sel => document.querySelector(sel);
const el = (tag, attrs = {}, children = []) => {
  const n = document.createElement(tag);
  for (const [k, v] of Object.entries(attrs)) {
    if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
    else if (k === 'html') n.innerHTML = v;
    else n.setAttribute(k, v);
  }
  (Array.isArray(children) ? children : [children]).forEach(c => {
    if (c == null) return;
    n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
  });
  return n;
};
function safeJSON(str){ try { return JSON.parse(str); } catch { return null; } }
const vibrate = p => ('vibrate' in navigator) && navigator.vibrate(p);
const isSecure = () => window.isSecureContext;

// === State ===
let ndef = null;
let scanAbort = null;
let scanning = false;
let lastSerial = null;
let records = []; // {recordType, mediaType?, id?, value}
const STORE_TEMPLATES = 'nfc_editor_templates_v3';

// === UI Refs ===
const compat = $('#compat');
const last = $('#last');
const count = $('#count');
const list = $('#list');
const hint = $('#hint');
const dot = $('#dot');
const stateTxt = $('#stateTxt');

// === Compatibility ===
(function checkCompat(){
  const hasNFC = 'NDEFReader' in window;
  const msg = !isSecure() ? 'Se requiere HTTPS o localhost.' : hasNFC ? 'OK: Web NFC disponible.' : 'No disponible: usa Chrome en Android.';
  if (compat){ compat.textContent = msg; compat.style.color = (!isSecure()||!hasNFC)? '#fca5a5' : ''; }
})();

function setScanUI(on){
  scanning = !!on;
  dot && dot.classList.toggle('on', on);
  stateTxt && (stateTxt.textContent = on ? 'Escaneando — acerca un tag' : 'Inactivo');
}

// === Render ===
function render(){
  if (!list) return;
  list.innerHTML = '';
  if (count) count.textContent = records.length;
  if (records.length === 0){
    list.appendChild(el('div',{class:'help'},'Sin registros. Escanea un tag o agrega uno nuevo.'));
    return;
  }
  records.forEach((r, i) => {
    const card = el('div', {class:'rec'});
    card.appendChild(el('h3',{},`#${i} — ${String(r.recordType||'unknown').toUpperCase()}`));
    const meta = el('div',{class:'help'}, (r.mediaType||r.id||'').toString());
    card.appendChild(meta);
    const ta = el('textarea',{rows:4}); ta.value = r.value||''; ta.oninput = e=>{ records[i].value = e.target.value; };
    const typeSel = el('select',{},[
      el('option',{value:'text'},'text'),
      el('option',{value:'url'},'url'),
      el('option',{value:'mime'},'mime'),
      el('option',{value:'unknown'},'unknown'),
    ]); typeSel.value = r.recordType||'text'; typeSel.onchange = e=>{ records[i].recordType = e.target.value; render(); };
    const actions = el('div',{class:'actions', style:'margin-top:8px'},[
      typeSel,
      el('button',{class:'ghost', onclick:()=>{ const c = JSON.parse(JSON.stringify(records[i])); records.splice(i+1,0,c); render(); }},'Duplicar'),
      el('button',{class:'danger', onclick:()=>{ records.splice(i,1); render(); }},'Eliminar')
    ]);
    card.appendChild(ta); card.appendChild(actions);
    list.appendChild(card);
  });
}

// === NDEF Parsing (robusto) ===
const URL_PREFIXES = [
  '', 'http://www.','https://www.','http://','https://','tel:','mailto:',
  'ftp://anonymous:anonymous@','ftp://ftp.','ftps://','sftp://','smb://','nfs://','ftp://','dav://','news:',
  'telnet://','imap://','rtsp://','urn:','pop:','sip:','sips:','tftp:','btspp://','btl2cap://','btgoep://',
  'tcpobex://','irdaobex://','file://','urn:epc:id:','urn:epc:tag:','urn:epc:pat:','urn:epc:raw:','urn:epc:','urn:nfc:'
];
function bytesToHex(u8){ return Array.from(u8).map(b=>b.toString(16).padStart(2,'0')).join(' ').toUpperCase(); }
function parseRecord(rec){
  let value = '';
  try{
    const dv = rec.data; if(!dv) return {recordType: rec.recordType||'unknown', mediaType: rec.mediaType||'', id: rec.id||'', value: ''};
    const u8 = new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
    if(rec.recordType === 'text' || (rec.recordType==='unknown' && (rec.mediaType||'').startsWith('text'))){
      const status = u8[0]; const langLen = status & 0x3f; const isUTF16 = (status & 0x80)!==0;
      if(u8.length>1+langLen){ value = new TextDecoder(isUTF16?'utf-16':'utf-8').decode(u8.subarray(1+langLen)); }
      else { value = new TextDecoder('utf-8').decode(u8); }
      return {recordType:'text', mediaType: rec.mediaType||'', id: rec.id||'', value};
    }
    if(rec.recordType === 'url' || (rec.recordType==='unknown' && (rec.mediaType||'').includes('uri'))){
      const prefixIdx = u8[0]; const rest = new TextDecoder('utf-8').decode(u8.subarray(1));
      value = (URL_PREFIXES[prefixIdx]||'') + rest;
      return {recordType:'url', mediaType: rec.mediaType||'', id: rec.id||'', value};
    }
    if(rec.mediaType && rec.mediaType.startsWith('text')){
      value = new TextDecoder('utf-8').decode(u8);
      return {recordType:'mime', mediaType: rec.mediaType, id: rec.id||'', value};
    }
    // fallback
    try{ value = new TextDecoder('utf-8').decode(u8); } catch{ value = bytesToHex(u8); }
    return {recordType: rec.recordType||'unknown', mediaType: rec.mediaType||'', id: rec.id||'', value};
  }catch(e){
    console.error('parseRecord error', e);
    return {recordType: rec.recordType||'unknown', mediaType: rec.mediaType||'', id: rec.id||'', value: ''};
  }
}

// === Scan / Write ===
async function startScan(){
  if(!('NDEFReader' in window)) return hint && (hint.textContent='Web NFC no soportado.');
  if(!isSecure()) return hint && (hint.textContent='HTTPS o localhost requerido.');
  try{
    if(scanAbort){ scanAbort.abort(); scanAbort=null; }
    scanAbort = new AbortController();
    ndef = new NDEFReader();
    await ndef.scan({ signal: scanAbort.signal, keepReading: true });
    ndef.onreadingerror = () => { hint && (hint.textContent='Error leyendo tag.'); };
    ndef.onreading = (ev) => {
      lastSerial = ev.serialNumber || 'desconocido';
      if(last) last.textContent = `Serial: ${lastSerial}`;
      records = [];
      for(const r of ev.message.records){ records.push(parseRecord(r)); }
      vibrate(20); render(); hint && (hint.textContent='Tag leído. Edita y escribe.');
    };
    setScanUI(true);
    hint && (hint.textContent = 'Escaneo activo. Acerca un tag al móvil.');
  }catch(e){
    console.error(e); setScanUI(false); hint && (hint.textContent = 'Error al iniciar escaneo: '+ (e?.message||e));
  }
}
function stopScan(){ try{ scanAbort?.abort(); }catch{} scanAbort=null; setScanUI(false); hint && (hint.textContent='Escaneo detenido.'); }

async function writeToTag(){
  if(!('NDEFReader' in window)) return hint && (hint.textContent='Web NFC no soportado.');
  if(!isSecure()) return hint && (hint.textContent='HTTPS o localhost requerido.');
  if(records.length===0) return alert('No hay registros para escribir.');
  if(!confirm('Se escribirá el contenido actual en la tarjeta. ¿Continuar?')) return;
  try{
    const payload = records.map(r=>({
      recordType: r.recordType||'text',
      ...(r.mediaType?{mediaType:r.mediaType}:{}),
      ...(r.id?{id:r.id}:{}),
      data: r.value ?? ''
    }));
    const writer = new NDEFReader();
    await writer.write({ records: payload });
    vibrate([30,40,30]);
    hint && (hint.textContent='Escritura completada.');
  }catch(e){
    console.error(e); hint && (hint.textContent='Error al escribir: '+(e?.message||e));
  }
}

// === Templates ===
function loadTemplates(){ const s = localStorage.getItem(STORE_TEMPLATES); return s ? (safeJSON(s)||{}) : {}; }
function saveTemplates(obj){ localStorage.setItem(STORE_TEMPLATES, JSON.stringify(obj)); updateTemplateChips(); }
function updateTemplateChips(){
  const wrap = $('#tmplChips'); if(!wrap) return; wrap.innerHTML='';
  const tmpls = loadTemplates();
  const names = Object.keys(tmpls);
  if(names.length===0){ wrap.appendChild(el('div',{class:'help'},'Sin plantillas guardadas.')); return; }
  names.forEach(name=>{
    const chip = el('div',{class:'pill',style:'cursor:pointer'}, name);
    chip.onclick = ()=>{ records = JSON.parse(JSON.stringify(tmpls[name].records||[])); render(); alert('Plantilla cargada: '+name); };
    chip.oncontextmenu = (ev)=>{ ev.preventDefault(); if(confirm('Eliminar plantilla "'+name+'"?')){ delete tmpls[name]; saveTemplates(tmpls); } };
    wrap.appendChild(chip);
  });
}
function saveCurrentAsTemplate(){
  const name = (document.getElementById('tmplName')?.value||'').trim();
  if(!name) return alert('Ponle un nombre a la plantilla.');
  if(records.length===0) return alert('No hay registros para guardar.');
  const tmpls = loadTemplates();
  tmpls[name] = { createdAt: new Date().toISOString(), records: JSON.parse(JSON.stringify(records)) };
  saveTemplates(tmpls); document.getElementById('tmplName').value=''; alert('Plantilla guardada.');
}
function mergeTemplates(imported){ const current = loadTemplates(); Object.assign(current, imported); saveTemplates(current); alert('Plantillas importadas y guardadas.'); }

// Import templates
const fileTemplate = document.getElementById('fileTemplate');
if(fileTemplate){
  fileTemplate.addEventListener('change', ev=>{
    const f = ev.target.files[0]; if(!f) return;
    const fr = new FileReader();
    fr.onload = e=>{
      const imported = safeJSON(e.target.result);
      if(imported && typeof imported==='object') mergeTemplates(imported);
      else alert('Archivo de plantilla inválido');
    };
    fr.readAsText(f);
  });
}

// Export templates
function exportTemplates(){ const data = loadTemplates(); if(Object.keys(data).length===0) return alert('No hay plantillas.'); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=el('a',{href:url,download:'nfc_templates.json'}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

// === Backup (de registros actuales) ===
function makeBackup(){ if(records.length===0) return alert('No hay datos para backup.'); const dump={exportedAt:new Date().toISOString(), serial:lastSerial, records}; const blob=new Blob([JSON.stringify(dump,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=el('a',{href:url,download:'nfc-backup-'+(lastSerial||'sin-serial')+'.json'}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function loadBackup(){ const inp=document.getElementById('fileBackup'); inp?.click(); }
const fileBackup = document.getElementById('fileBackup');
if(fileBackup){ fileBackup.addEventListener('change', ev=>{ const f=ev.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=e=>{ const parsed=safeJSON(e.target.result); if(parsed&&parsed.records){ records = parsed.records; render(); alert('Backup cargado.'); } else alert('Backup inválido.'); }; fr.readAsText(f); }); }

// === Replace tools ===
function replaceInRecords(findText, replaceText, replaceAll){ if(!findText) return alert('Escribe texto a buscar.'); let n=0; records = records.map(rec=>{ if(typeof rec.value==='string' && rec.value.includes(findText)){ rec.value = replaceAll ? rec.value.split(findText).join(replaceText) : rec.value.replace(findText, replaceText); n++; } return rec; }); render(); alert('Reemplazado en '+n+' registro(s).'); }

// === Events wiring ===
document.getElementById('btnScan')?.addEventListener('click', startScan, {passive:true});
document.getElementById('btnStop')?.addEventListener('click', stopScan, {passive:true});
document.getElementById('btnWrite')?.addEventListener('click', writeToTag, {passive:true});
document.getElementById('btnBackup')?.addEventListener('click', makeBackup);
document.getElementById('btnLoadBackup')?.addEventListener('click', loadBackup);
document.getElementById('btnSaveTmpl')?.addEventListener('click', saveCurrentAsTemplate);
document.getElementById('btnExportTmpl')?.addEventListener('click', exportTemplates);
document.getElementById('btnImportTmpl')?.addEventListener('click', ()=> document.getElementById('fileTemplate')?.click());
document.getElementById('btnReplaceOne')?.addEventListener('click', ()=>{ const f=document.getElementById('qFind').value; const r=document.getElementById('qRepl').value; replaceInRecords(f,r,false); });
document.getElementById('btnReplaceAll')?.addEventListener('click', ()=>{ const f=document.getElementById('qFind').value; const r=document.getElementById('qRepl').value; replaceInRecords(f,r,true); });
document.getElementById('btnAdd')?.addEventListener('click', ()=>{ records.push({recordType:'text', value:''}); render(); });
document.getElementById('btnClear')?.addEventListener('click', ()=>{ if(confirm('¿Limpiar editor?')){ records=[]; render(); } });

// Inicial
updateTemplateChips();
render();
</script>
</body>
</html>
